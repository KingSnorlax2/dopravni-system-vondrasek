// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Auto {
  id              Int       @id @default(autoincrement())
  spz             String    @unique
  znacka          String
  model           String
  rokVyroby       Int
  najezd          Int
  stav            String
  poznamka        String?
  datumSTK        DateTime?
  thumbnailFotoId String?
  thumbnailUrl    String?
  fotky           Fotka[]   @relation("AutoFotky")
  poznatky        Note[]    @relation("AutoNotes")
  transakce       Transakce[] @relation("AutoTransakce")
  gpsZaznamy     GPSZaznam[] @relation("AutoGPS")
  udrzby          Udrzba[]  @relation("AutoUdrzba")
  tankovani       Tankovani[] @relation("AutoTankovani")
  aktivni         Boolean @default(true)
  opravy          Oprava[]    @relation("AutoOpravy")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  gpsDeviceId     String?     @unique
  lastLatitude    Float?
  lastLongitude   Float?
  lastLocationUpdate DateTime?
  locations       VehicleLocation[]
  department      String?     // Department assignment for role-based access
  assignedDriver  String?     // Assigned driver ID
  assignedDriverUser User?    @relation("DriverVehicles", fields: [assignedDriver], references: [id])

  Transakce Transakce[]
}

model Fotka {
  id        String   @id @default(cuid())
  data      String   @db.Text
  mimeType  String
  autoId    Int?
  positionX Float?
  positionY Float?
  scale     Float?
  auto      Auto?    @relation("AutoFotky", fields: [autoId], references: [id], onDelete: Cascade)
}

model Note {
  id        Int      @id @default(autoincrement())
  text      String
  auto      Auto     @relation("AutoNotes", fields: [autoId], references: [id], onDelete: Cascade)
  autoId    Int
  createdAt DateTime @default(now())
}

model Kategorie {
  id         Int         @id @default(autoincrement())
  nazev      String     @unique
  transakce  Transakce[]
}

model Transakce {
  id          Int       @id @default(autoincrement())
  nazev       String
  castka      Float
  datum       DateTime
  typ         String
  popis       String
  kategorieId Int?
  kategorie   Kategorie? @relation(fields: [kategorieId], references: [id])
  autoId      Int?
  auto        Auto?    @relation(fields: [autoId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  faktura     String?
  fakturaTyp  String?
  fakturaNazev String?
  approvedBy  String?   // User ID who approved the transaction
  approvedAt  DateTime? // When the transaction was approved
  status      TransactionStatus @default(PENDING)

  Auto Auto[] @relation("AutoTransakce")
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model GPSZaznam {
  id        Int      @id @default(autoincrement())
  autoId    Int
  auto      Auto     @relation("AutoGPS", fields: [autoId], references: [id], onDelete: Cascade)
  latitude  Float
  longitude Float
  rychlost  Float?
  cas       DateTime @default(now())
  stav      String?  // např. "jízda", "parkování", "volnoběh"
}

model Udrzba {
  id          Int      @id @default(autoincrement())
  autoId      Int
  auto        Auto     @relation("AutoUdrzba", fields: [autoId], references: [id], onDelete: Cascade)
  datumUdrzby DateTime
  popis       String
  cena        Float
  typUdrzby   String   
  stav        String   
  servis      String?
  poznamka    String?
  approvedBy  String?  // User ID who approved the maintenance
  approvedAt  DateTime? // When the maintenance was approved
  status      MaintenanceStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum MaintenanceStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Tankovani {
  id        Int      @id @default(autoincrement())
  autoId    Int
  auto      Auto     @relation("AutoTankovani", fields: [autoId], references: [id], onDelete: Cascade)
  datum     DateTime
  litry     Float
  cena      Float
  poznamka  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ArchivedAuto {
  id              Int       @id @default(autoincrement())
  spz             String
  znacka          String
  model           String
  rokVyroby       Int
  najezd          Int
  stav            String
  poznamka        String?
  datumSTK        DateTime?
  thumbnailFotoId String?
  thumbnailUrl    String?
  aktivni         Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  archivedAt      DateTime @default(now())
  archivedBy      String?  // User ID who archived the vehicle
}

model Oprava {
  id        Int       @id @default(autoincrement())
  autoId    Int
  auto      Auto      @relation("AutoOpravy", fields: [autoId], references: [id], onDelete: Cascade)
  kategorie String
  popis     String
  datum     DateTime
  najezd    Int
  poznamka  String?
  cena      Float?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Settings {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  category  String
  label     String
  type      String   // "text", "number", "boolean", "select"
  options   Json?    // For select type settings
  updatedAt DateTime @updatedAt
}

enum UserStatus {
  ACTIVE
  DISABLED
  SUSPENDED
}

// Enhanced Role system with dynamic capabilities
model Role {
  id                    Int    @id @default(autoincrement())
  name                  String @unique
  displayName           String // User-friendly display name
  description           String // Detailed description of the role
  icon                  String? // Icon/emoji for the role
  color                 String? // Color theme for the role
  isSystem              Boolean @default(false) // System roles cannot be deleted
  isActive              Boolean @default(true)
  priority              Int     @default(0) // Higher number = higher priority
  
  // Navigation and access
  allowedPages          String[] // List of allowed page routes for this role
  defaultLandingPage    String? // Default landing page for this role
  
  // Dynamic rules configuration
  dynamicRules          Json? // JSON configuration for dynamic permission rules
  
  // Relationships
  users                 UserRole[]
  permissions           RolePermission[]
  departmentAssignments RoleDepartmentAssignment[]
  
  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String? // User ID who created this role
}

// Department assignments for role-based access control
model RoleDepartmentAssignment {
  id         Int    @id @default(autoincrement())
  roleId     Int
  role       Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  department String // Department name
  canManage  Boolean @default(false) // Can manage this department
  canView    Boolean @default(true)  // Can view this department
  
  @@unique([roleId, department])
}

model UserRole {
  id     Int   @id @default(autoincrement())
  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  role   Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId Int
  assignedAt DateTime @default(now())
  assignedBy String? // User ID who assigned this role
  
  @@unique([userId, roleId])
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String    @unique
  username        String?   @unique
  password        String
  resetToken      String?   @unique
  resetTokenExpiry DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  status          UserStatus @default(ACTIVE)
  
  // Enhanced user profile
  department      String?   // Department assignment
  position        String?   // Job position/title
  phone           String?   // Contact phone
  avatar          String?   // Avatar URL
  lastLoginAt     DateTime? // Last login timestamp
  trustScore      Int       @default(100) // Trust/reliability score (0-100)
  
  // Relationships
  roles           UserRole[]
  assignedVehicles Auto[] @relation("DriverVehicles") // Vehicles assigned to this driver
  preferences     UserPreferences? // User preferences and settings
  
  // Audit
  createdBy       String?   // User ID who created this user
  updatedBy       String?   // User ID who last updated this user
}

// User preferences and settings
model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Navigation preferences
  defaultLandingPage String  @default("/homepage")
  
  // Display preferences
  theme             String   @default("system") // system, light, dark
  language          String   @default("cs")     // cs, en
  
  // Notification preferences
  emailNotifications Boolean @default(true)
  pushNotifications Boolean @default(true)
  smsNotifications  Boolean @default(false)
  
  // Display settings
  compactMode       Boolean @default(false)
  showAvatars       Boolean @default(true)
  autoRefresh       Boolean @default(true)
  
  // Custom preferences (JSON field for extensibility)
  customSettings    Json?   // Additional user-specific settings
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
}

model DriverRouteLogin {
  id            Int      @id @default(autoincrement())
  ridicEmail    String
  cisloTrasy    String
  casPrihlaseni DateTime @default(now())
}

model VehicleLocation {
  id            String   @id @default(uuid())
  autoId        Int
  latitude      Float
  longitude     Float
  speed         Float?
  heading       Float?
  altitude      Float?
  accuracy      Float?
  batteryLevel  Float?
  timestamp     DateTime @default(now())
  
  auto          Auto     @relation(fields: [autoId], references: [id], onDelete: Cascade)
}

// Comprehensive permission system
enum PermissionKey {
  // Dashboard permissions
  view_dashboard
  customize_dashboard
  export_dashboard
  
  // User management
  view_users
  create_users
  edit_users
  delete_users
  assign_roles
  manage_roles
  
  // Vehicle management
  view_vehicles
  create_vehicles
  edit_vehicles
  delete_vehicles
  track_vehicles
  assign_vehicles
  
  // Financial management
  view_transactions
  create_transactions
  edit_transactions
  delete_transactions
  approve_expenses
  view_financial_reports
  
  // Maintenance management
  view_maintenance
  schedule_maintenance
  approve_maintenance
  edit_maintenance
  delete_maintenance
  track_service_history
  
  // Distribution management
  view_distribution
  manage_distribution
  assign_routes
  edit_routes
  
  // System administration
  system_settings
  view_audit_logs
  manage_departments
  backup_restore
  
  // Reports and analytics
  view_reports
  generate_reports
  export_reports
  view_analytics
  
  // Driver specific
  driver_access
  view_personal_history
  report_issues
  update_vehicle_status
}

model RolePermission {
  id        Int    @id @default(autoincrement())
  roleId    Int
  role      Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission PermissionKey
  
  @@unique([roleId, permission])
}

// Audit log for role and permission changes
model RoleAuditLog {
  id          Int      @id @default(autoincrement())
  action      String   // CREATE, UPDATE, DELETE, ASSIGN, REVOKE
  entityType  String   // ROLE, PERMISSION, USER_ROLE
  entityId    String   // ID of the affected entity
  oldValue    Json?    // Previous value
  newValue    Json?    // New value
  userId      String   // User who performed the action
  timestamp   DateTime @default(now())
  ipAddress   String?  // IP address of the user
  userAgent   String?  // User agent string
}